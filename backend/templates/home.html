<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Localização - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .status-driving { color: #007bff; }
        .status-stopped { color: #ffc107; }
        .status-break { color: #6c757d; }
        
        .location-card {
            transition: transform 0.2s;
        }
        .location-card:hover {
            transform: translateY(-2px);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .last-update {
            font-size: 0.8em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-map-marker-alt"></i> Sistema de Localização
            </span>
            <div class="d-flex">
                <button class="btn btn-outline-light" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
        </div>
    </nav>


    <!-- Seção de Links das APIs POST -->
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning">
                    <h6 class="mb-3"><i class="fas fa-paper-plane"></i> Endpoints de POST (Envio de Dados):</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <strong><i class="fas fa-location-arrow"></i> Enviar Localização:</strong><br>
                                <small class="text-muted">Envia dados de GPS do motorista</small><br>
                                <a href="/api/v1/driver-locations/send_location/" target="_blank" class="text-decoration-none">
                                    <code class="text-success">POST /api/v1/driver-locations/send_location/</code>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <strong><i class="fas fa-play"></i> Iniciar Viagem:</strong><br>
                                <small class="text-muted">Inicia uma nova viagem</small><br>
                                <a href="/api/v1/driver-trips/start_trip/" target="_blank" class="text-decoration-none">
                                    <code class="text-success">POST /api/v1/driver-trips/start_trip/</code>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <strong><i class="fas fa-stop"></i> Completar Viagem:</strong><br>
                                <small class="text-muted">Finaliza uma viagem em andamento</small><br>
                                <a href="/api/v1/driver-trips/1/complete_trip/" target="_blank" class="text-decoration-none">
                                    <code class="text-success">POST /api/v1/driver-trips/{id}/complete_trip/</code>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <strong><i class="fas fa-user-plus"></i> Criar Usuário:</strong><br>
                                <small class="text-muted">Registra novo usuário</small><br>
                                <a href="/api/v1/users/" target="_blank" class="text-decoration-none">
                                    <code class="text-success">POST /api/v1/users/</code>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <strong><i class="fas fa-map-marker-alt"></i> Criar Local:</strong><br>
                                <small class="text-muted">Adiciona novo local fixo</small><br>
                                <a href="/api/v1/locations/" target="_blank" class="text-decoration-none">
                                    <code class="text-success">POST /api/v1/locations/</code>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <strong><i class="fas fa-flask"></i> Criar Sessão:</strong><br>
                                <small class="text-muted">Cria nova sessão de teste</small><br>
                                <a href="/api/v1/test-sessions/" target="_blank" class="text-decoration-none">
                                    <code class="text-success">POST /api/v1/test-sessions/</code>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Nota:</strong> Endpoints de POST requerem autenticação e dados no corpo da requisição
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h4 id="online-drivers">-</h4>
                        <p class="mb-0">Motoristas Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-route fa-2x mb-2"></i>
                        <h4 id="active-trips">-</h4>
                        <p class="mb-0">Viagens Ativas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h4 id="trips-today">-</h4>
                        <p class="mb-0">Viagens Hoje</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-map-pin fa-2x mb-2"></i>
                        <h4 id="locations-today">-</h4>
                        <p class="mb-0">Localizações Hoje</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Status:</label>
                                <select class="form-select" id="statusFilter" onchange="filterLocations()">
                                    <option value="">Todos</option>
                                    <option value="online">Online</option>
                                    <option value="offline">Offline</option>
                                    <option value="driving">Dirigindo</option>
                                    <option value="stopped">Parado</option>
                                    <option value="break">Em Pausa</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="onlineFilter" class="form-label">Conectividade:</label>
                                <select class="form-select" id="onlineFilter" onchange="filterLocations()">
                                    <option value="">Todos</option>
                                    <option value="true">Online</option>
                                    <option value="false">Offline</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="searchInput" class="form-label">Buscar Motorista:</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Nome ou usuário do motorista..." onkeyup="filterLocations()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Atualizações de Localização -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i> Atualizações de Localização
                            <span class="badge bg-primary ms-2" id="total-locations">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="locations-list">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2">Carregando atualizações...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão de atualização flutuante -->
    <button class="btn btn-primary btn-lg refresh-btn" onclick="refreshData()" title="Atualizar dados">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allLocations = [];
        let filteredLocations = [];

        // Carrega os dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            // Atualiza automaticamente a cada 30 segundos
            setInterval(refreshData, 30000);
        });

        async function refreshData() {
            try {
                // Carrega estatísticas
                const statsResponse = await fetch('/api/v1/home/stats/');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateStats(stats);
                } else {
                    console.warn('Erro ao carregar estatísticas:', statsResponse.status);
                }

                // Carrega localizações
                const locationsResponse = await fetch('/api/v1/home/');
                if (locationsResponse.ok) {
                    const locations = await locationsResponse.json();
                    // Garante que locations seja sempre um array
                    allLocations = Array.isArray(locations) ? locations : [];
                } else {
                    console.warn('Erro ao carregar localizações:', locationsResponse.status);
                    // Se houver erro, mantém allLocations como array vazio
                    allLocations = [];
                }
                
                // Sempre garante que filteredLocations seja um array
                filteredLocations = Array.isArray(allLocations) ? [...allLocations] : [];
                displayLocations();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                // Em caso de erro, define arrays vazios
                allLocations = [];
                filteredLocations = [];
                showError('Erro ao carregar dados. Tente novamente.');
            }
        }

        function updateStats(stats) {
            if (stats) {
                document.getElementById('online-drivers').textContent = stats.online_drivers || 0;
                document.getElementById('active-trips').textContent = stats.active_trips || 0;
                document.getElementById('trips-today').textContent = stats.trips_today || 0;
                document.getElementById('locations-today').textContent = stats.locations_today || 0;
            }
        }

        function displayLocations() {
            const container = document.getElementById('locations-list');
            const totalElement = document.getElementById('total-locations');
            
            // Garante que filteredLocations seja um array
            const safeFilteredLocations = Array.isArray(filteredLocations) ? filteredLocations : [];
            totalElement.textContent = safeFilteredLocations.length;

            if (safeFilteredLocations.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-map-marker-alt fa-3x mb-3"></i><p>Nenhuma localização encontrada</p></div>';
                return;
            }

            container.innerHTML = safeFilteredLocations.map(location => `
                <div class="card location-card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-1">
                                    <i class="fas fa-user"></i> ${location.driver_name}
                                </h6>
                                <small class="text-muted">@${location.driver_username}</small>
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-${getStatusColor(location.status)}">
                                    <i class="fas fa-${getStatusIcon(location.status)}"></i> ${getStatusText(location.status)}
                                </span>
                                ${location.is_online ? '<span class="badge bg-success ms-1">Online</span>' : '<span class="badge bg-danger ms-1">Offline</span>'}
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Coordenadas:</small><br>
                                <code>${location.latitude}, ${location.longitude}</code>
                            </div>
                            <div class="col-md-2">
                                ${location.speed ? `<small class="text-muted">Velocidade:</small><br><strong>${location.speed} km/h</strong>` : ''}
                                ${location.battery_level ? `<br><small class="text-muted">Bateria: ${location.battery_level}%</small>` : ''}
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Última atualização:</small><br>
                                <strong>${formatDateTime(location.timestamp)}</strong>
                                <br><span class="last-update">${location.last_update_minutes_ago} min atrás</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterLocations() {
            const statusFilter = document.getElementById('statusFilter').value;
            const onlineFilter = document.getElementById('onlineFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Garante que allLocations seja um array antes de filtrar
            const safeAllLocations = Array.isArray(allLocations) ? allLocations : [];
            
            filteredLocations = safeAllLocations.filter(location => {
                const matchesStatus = !statusFilter || location.status === statusFilter;
                const matchesOnline = onlineFilter === '' || location.is_online.toString() === onlineFilter;
                const matchesSearch = !searchTerm || 
                    (location.driver_name && location.driver_name.toLowerCase().includes(searchTerm)) ||
                    (location.driver_username && location.driver_username.toLowerCase().includes(searchTerm));

                return matchesStatus && matchesOnline && matchesSearch;
            });

            displayLocations();
        }

        function getStatusColor(status) {
            const colors = {
                'online': 'success',
                'offline': 'danger',
                'driving': 'primary',
                'stopped': 'warning',
                'break': 'secondary'
            };
            return colors[status] || 'secondary';
        }

        function getStatusIcon(status) {
            const icons = {
                'online': 'circle',
                'offline': 'times-circle',
                'driving': 'car',
                'stopped': 'pause-circle',
                'break': 'coffee'
            };
            return icons[status] || 'question-circle';
        }

        function getStatusText(status) {
            const texts = {
                'online': 'Online',
                'offline': 'Offline',
                'driving': 'Dirigindo',
                'stopped': 'Parado',
                'break': 'Em Pausa'
            };
            return texts[status] || status;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }

        function showError(message) {
            const container = document.getElementById('locations-list');
            container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
        }
    </script>
</body>
</html>
